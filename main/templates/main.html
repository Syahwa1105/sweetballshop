{% extends "base.html" %}
{% load static %}

{% block title %}SweetBall Shop{% endblock %}

{% block content %}
  {% include "navbar.html" %}

  <div class="max-w-6xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold text-text-dark mb-4">SweetBall Shop</h1>
    <p class="text-sm text-gray-500 mb-6">
      NPM: {{ npm }} | Nama: {{ nama }} | Kelas: {{ kelas }}
      <br>
      <span class="italic">Sesi terakhir login: {{ last_login }}</span>
    </p>

    <div class="flex gap-3 mb-6">
      <a href="?filter=all" id="allBtn" class="btn-sweet btn-peach">All Products</a>
      <a href="?filter=my" id="myBtn" class="btn-sweet btn-mint">My Products</a>
      <button id="refreshBtn" class="btn-sweet btn-mint">â†» Refresh</button>
      <button id="openModalBtn" class="btn-sweet btn-pink">+ Add Product</button>
    </div>

    <div id="product-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
     
    </div>
  </div>

  <!--  Modal Tambah Produk  -->
  <div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-center">Tambah Produk Baru</h2>
      <form id="addProductForm" class="space-y-3" method="POST">
        {% csrf_token %}
        <input type="text" name="name" placeholder="Nama Produk" class="border p-2 w-full rounded" required>
        <input type="number" name="price" placeholder="Harga" class="border p-2 w-full rounded" required>
        <input type="url" name="thumbnail" placeholder="URL Gambar" class="border p-2 w-full rounded" required>
        <textarea name="description" placeholder="Deskripsi" class="border p-2 w-full rounded" required></textarea>
        <select name="category" class="border p-2 w-full rounded">
          <option value="shoes">Shoes</option>
          <option value="clothes">Clothes</option>
          <option value="accessories">Accessories</option>
          <option value="limited">Limited Edition</option>
        </select>
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" name="is_featured"> Featured Product
        </label>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="cancelBtn" class="btn-sweet btn-mint">Batal</button>
          <button type="submit" class="btn-sweet btn-pink">Tambah</button>
        </div>
      </form>
    </div>
  </div>

  <!--  Modal Edit Produk  -->
  <div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-center">Edit Produk</h2>
      <form id="editProductForm" class="space-y-3" method="POST">
        {% csrf_token %}
        <input type="hidden" id="edit-id" name="id">
        <input type="text" id="edit-name" name="name" class="border p-2 w-full rounded" required>
        <input type="number" id="edit-price" name="price" class="border p-2 w-full rounded" required>
        <input type="url" id="edit-thumbnail" name="thumbnail" class="border p-2 w-full rounded" required>
        <textarea id="edit-description" name="description" class="border p-2 w-full rounded" required></textarea>
        <select id="edit-category" name="category" class="border p-2 w-full rounded">
          <option value="shoes">Shoes</option>
          <option value="clothes">Clothes</option>
          <option value="accessories">Accessories</option>
          <option value="limited">Limited Edition</option>
        </select>
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" id="cancelEditBtn" class="btn-sweet btn-mint">Batal</button>
          <button type="submit" class="btn-sweet btn-pink">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!--  Modal Detail Produk  -->
  <div id="detailProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg text-center">
      <img id="detail-image" src="" alt="Product Image" class="w-full h-48 object-cover rounded-md mb-3">
      <h2 id="detail-name" class="text-xl font-semibold text-gray-800 mb-2"></h2>
      <p id="detail-description" class="text-gray-600 text-sm mb-2"></p>
      <p id="detail-price" class="font-bold text-peach-600 mb-1"></p>
      <p id="detail-category" class="text-xs text-gray-500 mb-1"></p>

     
      <p id="detail-user" class="text-xs text-gray-500"></p>
      <p id="detail-created" class="text-xs text-gray-400"></p>

      <button id="closeDetailBtn" class="btn-sweet btn-mint mt-4">Tutup</button>
    </div>
  </div>

  <!-- Modal Konfirmasi Hapus -->
  <div id="confirmDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-80 shadow-lg text-center">
      <h3 class="text-lg font-semibold mb-4">Yakin ingin menghapus produk ini?</h3>
      <div class="flex justify-center gap-3">
        <button id="cancelDeleteBtn" class="btn-sweet btn-mint px-4">Batal</button>
        <button id="confirmDeleteBtn" class="btn-sweet btn-pink px-4">Hapus</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // CSRF 
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    // DOM Elements 
    const container = document.getElementById("product-container");
    const modal = document.getElementById("productModal");
    const editModal = document.getElementById("editProductModal");
    const deleteModal = document.getElementById("confirmDeleteModal");
    const detailModal = document.getElementById("detailProductModal");

    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    const closeDetailBtn = document.getElementById("closeDetailBtn");

    let productToDelete = null;
    let currentFilter = "all"; 

    const openModalBtn = document.getElementById("openModalBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const addForm = document.getElementById("addProductForm");
    const editForm = document.getElementById("editProductForm");

    
    document.getElementById("allBtn").addEventListener("click", e => {
      e.preventDefault();
      currentFilter = "all";
      loadProducts();
    });

    document.getElementById("myBtn").addEventListener("click", e => {
      e.preventDefault();
      currentFilter = "my";
      loadProducts();
    });

    
    function showState(msg, color = "gray") {
      container.innerHTML = `<p class="text-${color}-500 col-span-full text-center">${msg}</p>`;
    }

    async function loadProducts(category = "") {
      showState("Loading produk...", "blue");
      try {
        const url = `/products/json/?filter=${currentFilter}${category ? "&category=" + category : ""}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error();
        const data = await res.json();
        container.innerHTML = "";

        if (data.length === 0) {
          
          container.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center text-center">
              <img src="{% static 'image/no_product.png' %}" alt="No product" class="w-48 h-48 opacity-70 mb-3">
              <p class="text-gray-500 text-lg font-semibold">Belum ada produk.</p>
            </div>
          `;
          return;
        }

        
        data.forEach(item => {
          const p = item.fields;
          const pk = item.pk;
          container.innerHTML += `
            <div class="bg-white shadow-md rounded-lg p-4 hover:shadow-lg transition relative">
              <img src="${p.thumbnail}" alt="${p.name}" class="w-full h-48 object-cover rounded-md mb-3">
              <h3 class="text-lg font-semibold text-gray-800">${p.name}</h3>
              <p class="text-gray-600 text-sm mb-2 line-clamp-3">${p.description}</p>
              <p class="font-bold text-peach-600 mb-1">Rp ${p.price}</p>
              <p class="text-xs text-gray-400 mb-3">Kategori: ${p.category}</p>
              <div class="flex justify-between items-center mt-2">
                <button class="detail-btn card-btn card-btn-detail" data-id="${pk}">Detail</button>
                <div class="flex gap-2">
                  <button class="edit-btn card-btn card-btn-edit" data-id="${pk}">Edit</button>
                  <button class="delete-btn card-btn card-btn-delete" data-id="${pk}">Hapus</button>
                </div>
              </div>
            </div>`;
        });
        bindEvents();
      } catch {
        showState("Gagal memuat data produk.", "red");
      }
    }

    function bindEvents() {
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          productToDelete = btn.dataset.id;
          deleteModal.classList.remove("hidden");
        });
      });

      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const res = await fetch(`/json/${id}/`);
          const data = await res.json();
          const p = data[0].fields;
          document.getElementById("edit-id").value = id;
          document.getElementById("edit-name").value = p.name;
          document.getElementById("edit-price").value = p.price;
          document.getElementById("edit-thumbnail").value = p.thumbnail;
          document.getElementById("edit-description").value = p.description;
          document.getElementById("edit-category").value = p.category;
          editModal.classList.remove("hidden");
        });
      });

      document.querySelectorAll(".detail-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const res = await fetch(`/products/${id}/detail/`); 
          const p = await res.json();

          document.getElementById("detail-image").src = p.thumbnail || "{% static 'image/no_product.png' %}";
          document.getElementById("detail-name").textContent = p.name;
          document.getElementById("detail-description").textContent = p.description;
          document.getElementById("detail-price").textContent = `Rp ${p.price}`;
          document.getElementById("detail-category").textContent = `Kategori: ${p.category}`;

          
          if (document.getElementById("detail-user"))
            document.getElementById("detail-user").textContent = `Author: ${p.user || "Anonymous"}`;
          if (document.getElementById("detail-created"))
            document.getElementById("detail-created").textContent = p.created_at ? `Created at: ${p.created_at}` : "";

          detailModal.classList.remove("hidden");
        });
      });
    }

    closeDetailBtn.addEventListener("click", () => detailModal.classList.add("hidden"));

    confirmDeleteBtn.addEventListener("click", async () => {
      if (!productToDelete) return;
      const res = await fetch(`/products/${productToDelete}/delete/ajax/`, {
        method: "DELETE",
        headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken }
      });
      const result = await res.json();
      deleteModal.classList.add("hidden");
      productToDelete = null;
      if (result.status === "success") {
        showToast("Produk dihapus!", "success");
        loadProducts();
      } else showToast("Gagal menghapus!", "error");
    });

    cancelDeleteBtn.addEventListener("click", () => deleteModal.classList.add("hidden"));

    addForm.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(addForm);
      const res = await fetch("{% url 'main:add_product' %}", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken },
        body: formData
      });
      if (res.ok) {
        modal.classList.add("hidden");
        addForm.reset();
        showToast("Produk berhasil ditambahkan!", "success");
        loadProducts();
      } else showToast("Gagal menambah produk!", "error");
    });

    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("edit-id").value;
      const formData = new FormData(editForm);
      const res = await fetch(`/products/${id}/edit/`, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken },
        body: formData
      });
      if (res.ok) {
        editModal.classList.add("hidden");
        showToast("Produk berhasil diperbarui!", "success");
        loadProducts();
      } else showToast("Gagal update produk!", "error");
    });

    openModalBtn.addEventListener("click", () => modal.classList.remove("hidden"));
    cancelBtn.addEventListener("click", () => modal.classList.add("hidden"));
    cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));
    refreshBtn.addEventListener("click", () => loadProducts());

    // === Navbar category ===
    document.querySelectorAll("nav a").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const category = link.textContent.trim().toLowerCase();
        if (["home", "shoes", "clothes", "accessories", "limited edition"].includes(category)) {
          loadProducts(category === "home" ? "" : category);
        }
      });
    });

    loadProducts();
  });
  </script>
{% endblock content %}
